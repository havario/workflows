---
services:
  openresty:
    image: honeok/openresty:1.27.1.2-alpine
    container_name: openresty
    restart: unless-stopped
    environment:
      TZ: Asia/Shanghai
    volumes:
      - $PWD/nginx/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf
      - $PWD/nginx/conf.d:/etc/nginx/conf.d
      - $PWD/nginx/lua:/etc/nginx/lua
      - $PWD/nginx/certs:/etc/nginx/certs
      - $PWD/nginx/html:/usr/local/openresty/nginx/html
      - $PWD/nginx/logs:/usr/local/openresty/nginx/logs
      - php-socket:/run/php
    tmpfs:
      - /var/cache/openresty:rw,noexec,nosuid,size=512m
    network_mode: host

  mysql:
    image: mysql:8.0.42
    container_name: mysql
    restart: unless-stopped
    environment:
      TZ: Asia/Shanghai
      MYSQL_ROOT_PASSWORD: 8aDdVzUzXwjEAOhifFW6yg # openssl rand -base64 16
      MYSQL_USER: honeok
      MYSQL_PASSWORD: 4siz2vOewdLbww # openssl rand -base64 10
    volumes:
      - $PWD/mysql/my.cnf:/etc/my.cnf
      - $PWD/mysql/conf.d:/etc/mysql/conf.d
      - $PWD/mysql/data:/var/lib/mysql
    healthcheck:
      test:
        [
          "CMD-SHELL",
          'mysql --user=root --password=8aDdVzUzXwjEAOhifFW6yg --execute "SELECT 1"',
        ]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - web

  php:
    image: honeok/php:8.4.13-fpm-alpine
    container_name: php
    restart: unless-stopped
    environment:
      TZ: Asia/Shanghai
    volumes:
      - $PWD/nginx/html:/var/www/html
      - php-socket:/run/php
    networks:
      - web
    depends_on:
      mysql:
        condition: service_healthy

  redis:
    image: 8.0.4-alpine
    container_name: redis
    restart: unless-stopped
    environment:
      TZ: Asia/Shanghai
    volumes:
      - $PWD/redis/data:/data
    networks:
      - web

volumes:
  php-socket:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=64m

networks:
  web:
    driver: bridge
