# https://www.nodeseek.com/post-30779-1

upstream grpcserver {
    server 172.17.0.1:5555;
    keepalive 1024;
}

server {
    listen       80;
    listen       [::]:80;
    server_name  tz.pornhub.com;
    return 301   https://$host$request_uri;
}

server {
    listen       443 ssl;
    listen       [::]:443 ssl;
    listen       443 quic;
    listen       [::]:443 quic;
    server_name  tz.pornhub.com;

    resolver 1.1.1.1 8.8.8.8 223.5.5.5 valid=300s;
    resolver_timeout 5s;

    ssl_certificate      /etc/nginx/certs/pornhub.com_cert.pem;
    ssl_certificate_key  /etc/nginx/certs/pornhub.com_key.pem;

    underscores_in_headers on; # 允许客户端请求头字段名中出现下划线

    keepalive_time     24h;
    keepalive_timeout  120s;
    keepalive_requests 100000;

    # 关闭缓存
    proxy_cache off;
    proxy_buffering off;
    client_max_body_size 25m;
    add_header Alt-Svc 'h3=":443"; ma=86400,h3-25=":443"; ma=86400,h3-29=":443"; ma=86400';

    location / {
        proxy_pass         http://172.17.0.1:8080;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Host $host;
    }

    location ~ ^/(ws|terminal/.+|file/.+)$ {
        proxy_pass         http://172.17.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Host $host;
    }

    location ^~ /proto.NezhaService/ {
        access_log             off;
        grpc_pass              grpc://grpcserver;
    	grpc_socket_keepalive  on;        # 与上游grpc服务器的tcp连接上启用内核级的心跳探测
    	grpc_send_timeout      300s;      # 向上游发送请求的超时时间
        grpc_read_timeout      300s;      # 等待上游响应的超时时间
    }
}
